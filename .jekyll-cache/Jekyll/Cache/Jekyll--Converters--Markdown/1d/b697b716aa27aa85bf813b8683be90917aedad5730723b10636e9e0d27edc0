I"ª;<p>In this post Iâ€™m going to show how Powershell Desired State Configuration and Service Management Automation can be combined to ensure, all SMA Runbook Workers have the same configuration and set of additional Modules and SW packages installed.</p>

<p>Iâ€™m going through, step-by-step, so itâ€™s easier to follow the intention of this joint venture between SMA and DSC.</p>

<p>If youâ€™re not yet, but want to get into SMA and DSC I highly recommend to read my <a href="http://gallery.technet.microsoft.com/Service-Management-fcd75828/view/Reviews" target="_blank">SMA Whitepaper on Technet</a> as well as the TechNet documentation on <a href="http://blogs.technet.com/b/privatecloud/archive/2013/08/30/introducing-powershell-desired-state-configuration-dsc.aspx" target="_blank">Powershell DSC</a>.</p>

<p>So letâ€™s startâ€¦</p>

<h2 id="the-use-case-"><span style="text-decoration: underline;">The Use Case<br /> </span></h2>

<p>Having multiple Runbook workers weâ€™re in charge to ensure, all workers have the same set of additional Powershell modules, and SW Packages such as management consoles for the various System Center products, installed and available. Because the Runbook workers are picking up jobs (runbooks) to execute randomly or on a current load base, we have to ensure, all workers are in sync from the configuration perspective. In most cases it is more comfortable to install required modules and management consoles on the SMA Runbook workers instead of remoting into each management host, using CMDLETs and modules with implicit remoting keeps the runbooks cleaner as well.</p>

<h2 id="the-solution-quick-wrap-"><span style="text-decoration: underline;">The Solution (quick wrap)<br /> </span></h2>

<p>To achieve the goal we can leverage Powershell DSC which enables us to ensure that configurations like files and folders, SW packages, Registry Keys etc. exist in the way we need it or defined it for the target systems. The solution Iâ€™m gonna show here needs the following components.</p>

<ul>
  <li>A SMA Runbook which can be picked up by any active Runbook worker to execute the DSC Configurations</li>
  <li>A SMA Variable (defined the SMA Web Service Endpoint)</li>
  <li>A SMA Credential Object (used to push the DSC Configurations to all Runbook workers). The user must have administrative rights on all Runbook workers</li>
  <li>A central repository (SMB Share) for SW packages, Powershell modules, files and folders. The Computer Accounts from all Runbook workers must have â€œRead and Executeâ€ Permissions on the repository share</li>
</ul>

<p>Iâ€™m currently using the push architecture of DSC, however I might change that in the future to a pull-server based architecture to be more scalable and compliant with security regulations for segregated environments.</p>

<h2 id="scenario-overview-"><span style="text-decoration: underline;">Scenario Overview<br /> </span></h2>

<p><img src="http://www.miru.ch/wp-content/uploads/2014/02/022814_1327_UsingDSCtok1.png" alt="" /></p>

<p>I currently used the Package and the File resource from DSC. Both are built-in when you install WinRM 4.0.</p>

<p>Here is an example of a package definition:</p>

<pre>Â #Ops Manager Console
Â Â Â Â Â Â Â Â Â Â Â  Package OpsMgrConsole
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Name = "System Center Operations Manager 2012 Console"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Path = "\\ssma01\DSCResources\SWPackages\OpsMgr\Setup.exe"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ProductId = "041C3416-87CE-4B02-918E-6FDC95F241D3"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Arguments = "/silent /install /components:OMConsole /EnableErrorReporting:Never /SendCEIPReports:0 /UseMicrosoftUpdate:1 /AcceptEndUserLicenseAgreement:1"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ensure = "Present"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  DependsOn = "[Package]MSReportViewer"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReturnCode = 0
Â Â Â Â Â Â Â Â Â Â Â  }</pre>

<p>As you can see, this package resource will deploy an unattend installation of OpsMgr Console and has a dependency on the MS Report Viewer Package, which must be deployed first.</p>

<p>Here an example of a file resource I used to distribute additional standalone Powershell modules to my workers.</p>

<pre>#Powershell Modules
Â Â Â Â Â Â Â Â Â Â Â  File PSModules 
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  SourcePath = $ModuleSourcePath
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  DestinationPath = $ModulePath
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Recurse = $true
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Type = "Directory"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CheckSum = "SHA-256"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }</pre>

<p>But hey, how can I push the DSC configurations to all workers while one of them is going to execute the workflow himself when the runbook gets kicked off?</p>

<p>Hereâ€™s an extract of the runbook where you can see the magic.</p>

<pre>Â  #Get all SMA Runbook Workers by invoking a request to SMA Web Service Endpoint
Â Â Â Â Â Â Â  $SMARunbookNodes = (Get-SmaRunbookWorkerDeployment -WebServiceEndpoint $USING:SMAWebServiceEndpoint -Credential $USING:psusercred).ComputerName
Â Â Â Â Â Â Â  Write-OutPut "INFO: Now creating DSC Configurations for SMA Runbook Servers: $SMARunbookNodes"

Â Â Â Â Â Â Â  #Create the DSC Mof files for each Worker
Â Â Â Â Â Â Â  UpdateRBConfig -NodeName $SMARunbookNodes -OutputPath $USING:DSCConfigPath

Â Â Â Â Â Â Â  #Run the DSC Configuration
Â Â Â Â Â Â Â  Write-OutPut "INFO: Deploying DSC Configuration"
Â Â Â Â Â Â Â  Start-DscConfiguration -Path $USING:DSCConfigPath -Force -wait -verbose
Â Â Â Â Â Â Â  Write-OutPut "INFO: DSC Configuration Finished, Check Job History for Details"</pre>

<p>First Iâ€™m using a SMA Variable called $SMAWebServiceEndpoint where I defined the URI for SMA Web Service endpoint. Using the endpoint Iâ€™m gathering all Runbook worker deployments to get their host names. Invoking the DSC configuration information creates a .mof file for each of the workers.</p>

<p>So hereâ€™s the complete Runbook:</p>

<pre>workflow Update-SMARunbookWorkers
{
Â Â Â  &lt;#
Â Â Â  Project Name: Update-SMARunbookWorkers 
Â Â Â  Runbook Name: Update-SMARunbookWorkers
Â Â Â  Runbook Type: Process 
Â Â Â  Runbook Tags: Type:Process, Proj:Update Runbook Workers, DSC 
Â Â Â  Runbook Description: Execute DSC Configurations on all Runbook Workers 
Â Â Â  Runbook Author: Michael RÃ¼efli (www.miru.ch)
Â Â Â  Runbook Creation Date: 02/28/2014
Â Â Â  #&gt; 

Â Â Â  param(
Â Â Â Â Â Â Â  [Parameter(Mandatory=$true)]
Â Â Â Â Â Â Â  [SWITCH]$RebootWorkers
Â Â Â  )

Â Â Â  #Suspend Runbook on any error
Â Â Â  $ErrorActionPreference = "stop"

Â Â Â  #Get Defined Variables
Â Â Â  $SMAWebServiceEndpoint = Get-AutomationVariable -Name SMAWebServiceEndpoint

Â Â Â  #Get the Automation Credential 
Â Â Â  $PSUserCred = Get-AutomationPSCredential -Name SMAAdmin

Â Â Â  #Set the Output Path for local DSC Mof resources
Â Â Â  $DSCConfigPath = "C:\DSCConfigs\UpdateRBConfig"

Â Â Â  #We use an inline script for the DSC Configuration Part
Â Â Â  InlineScript
Â Â Â  {
Â Â Â Â Â Â Â  Configuration UpdateRBConfig 
Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â  param (
Â Â Â Â Â Â Â Â Â Â Â  [Parameter(Mandatory=$true)]
Â Â Â Â Â Â Â Â Â Â Â  [ValidateNotNullOrEmpty()]
Â Â Â Â Â Â Â Â Â Â Â  [String[]]$NodeName,

Â Â Â Â Â Â Â Â Â Â Â  [Parameter(Mandatory=$false)]
Â Â Â Â Â Â Â Â Â Â Â  [ValidateNotNullOrEmpty()]
Â Â Â Â Â Â Â Â Â Â Â  [String]$ModuleSourcePath = "\\ssma01\DSCResources\Modules",

Â Â Â Â Â Â Â Â Â Â Â  [Parameter(Mandatory=$false)]
Â Â Â Â Â Â Â Â Â Â Â  [ValidateNotNullOrEmpty()]
Â Â Â Â Â Â Â Â Â Â Â  [String]$ModulePath="$env:ProgramFiles\WindowsPowerShell\Modules"
Â Â Â Â Â Â Â Â Â Â Â  )

Â Â Â Â Â Â Â Â Â Â Â  Node $NodeName #we get the node names below by querying the SMA RB Worker Deployment
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  #Powershell Modules
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  File PSModules 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  SourcePath = $ModuleSourcePath
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  DestinationPath = $ModulePath
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Recurse = $true
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Type = "Directory"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CheckSum = "SHA-256"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  #SQL 2012 CLR Types
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Package SQL2K12CLRTypes
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Name = "Microsoft System CLR Types for SQL Server 2012 (x64)"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Path = "\\ssma01\DSCResources\SWPackages\SQLCLR2012\SQLSysClrTypes.msi"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ProductId = "F1949145-EB64-4DE7-9D81-E6D27937146C"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ensure = "Present"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReturnCode = 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  #Report Viewer 2010
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Package MSReportViewer
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Name = "Microsoft Report Viewer 2012 Runtime"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Path = "\\ssma01\DSCResources\SWPackages\ReportViewer\ReportViewer.msi"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ProductId = "421B88F8-D7C9-44CB-8B73-166D65B18DCC"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ensure = "Present"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  DependsOn = "[Package]SQL2K12CLRTypes"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReturnCode = 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  #Ops Manager Console
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Package OpsMgrConsole
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Name = "System Center Operations Manager 2012 Console"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Path = "\\ssma01\DSCResources\SWPackages\OpsMgr\Setup.exe"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ProductId = "041C3416-87CE-4B02-918E-6FDC95F241D3"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Arguments = "/silent /install /components:OMConsole /EnableErrorReporting:Never /SendCEIPReports:0 /UseMicrosoftUpdate:1 /AcceptEndUserLicenseAgreement:1"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ensure = "Present"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  DependsOn = "[Package]MSReportViewer"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReturnCode = 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  #SCVMM Console
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Package VMMConsole
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Name = "Microsoft System Center Virtual Machine Manager Administrator Console (x64)"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Path = "\\ssma01\DSCResources\SWPackages\SCVMM\setup.exe"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ProductId = "CDFB453F-5FA4-4884-B282-F46BDFC06051"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Arguments = "/client /i /IACCEPTSCEULA /f \\ssma01\DSCResources\SWPackages\SCVMM\VMClient.ini"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Ensure = "Present"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReturnCode = 0
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  ## Let's do it....
Â Â Â Â Â Â Â  #Get all SMA Runbook Workers by invoking a request to SMA Web Service Endpoint
Â Â Â Â Â Â Â  $SMARunbookNodes = (Get-SmaRunbookWorkerDeployment -WebServiceEndpoint $USING:SMAWebServiceEndpoint -Credential $USING:psusercred).ComputerName
Â Â Â Â Â Â Â  Write-OutPut "INFO: Now creating DSC Configurations for SMA Runbook Servers: $SMARunbookNodes"

Â Â Â Â Â Â Â  #Create the DSC Mof files for each Worker
Â Â Â Â Â Â Â  UpdateRBConfig -NodeName $SMARunbookNodes -OutputPath $USING:DSCConfigPath

Â Â Â Â Â Â Â  #Run the DSC Configuration
Â Â Â Â Â Â Â  Write-OutPut "INFO: Deploying DSC Configuration"
Â Â Â Â Â Â Â  Start-DscConfiguration -Path $USING:DSCConfigPath -Force -wait -verbose
Â Â Â Â Â Â Â  Write-OutPut "INFO: DSC Configuration Finished, Check Job History for Details"

Â Â Â Â Â Â Â  #Reboot the Runbook workers if Parameter was set to True
Â Â Â Â Â Â Â  If ($Using:RebootWorkers)
Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â  Write-OutPut "INFO: Rebooting SMA Runbook Servers: $SMARunbookNodes"
Â Â Â Â Â Â Â Â Â Â Â  $SMARunbookNodes | Restart-Computer -force
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â  Write-OutPut "INFO: Runbooked finished successfully, Check Job History for Details"
}</pre>

<h2 id="how-to-implement-the-solution"><span style="text-decoration: underline;">How to implement the solution</span></h2>

<ol>
  <li>Create a central accessible SMB share</li>
  <li>Make the share accessible to all your Runbook Worker Computer accounts</li>
  <li>Create a subfolder structure with two folder names Modules and SWPackages</li>
  <li>Place Modules and SW Binaries there accordingly (refer to paths defined in the runbook or adapt the paths there)</li>
  <li>Assign local admin permission to the RunbookÂ  service account on all workers</li>
  <li>Open the WAP Admin Portal, switch to the Automation Pane and create a new Runbook called â€œUpdate-SMARunbookWorkersâ€</li>
  <li>Paste the whole runbook code above, save and publish it</li>
  <li>Create a SMA credential object called â€œSMAAdminâ€ (if choosing another name, adapt the runbook). This user has to be added as a SMA Portal Admin in the next step</li>
  <li>Using the SMA Powershell Module, add the principal used as SMAAdmin credential to the SMA Administrators 
    &lt;pre&gt;$connectionstring = â€˜Server=srvdb01.miru.local\SysCtr;Initial Catalog=Microsoft.MgmtSvc.Store;User ID=sa;Password=Some@Passwordâ€™&lt;/pre&gt;</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div&gt;
  &lt;pre id="crayon-5310acb364b29756772483-2"&gt;Add-MgmtSvcAdminUser -ConnectionString $connectionstring -Principal 'DOMAIN\SecurityGroupName'&lt;/pre&gt;
&lt;/div&gt;
</code></pre></div></div>

<ol>
  <li>Create a SMA Variable named â€œSMAWebServiceEndpointâ€ and fill in the URL to your SMA Web Service endpoint (eg. â€œhttps://sma.yourdomain.comâ€)</li>
  <li>Optionally enable verbose logging for the runbook</li>
  <li>Execute it and have fun ğŸ™‚</li>
</ol>

<p>If youâ€™re familiar with the <a href="https://blogs.technet.com/b/privatecloud/archive/2013/10/23/automation-service-management-automation-sma-runbook-toolkit-spotlight-smart-for-runbook-import-and-export.aspx" target="_blank">SMART tool </a>you can also download the runbook from <a href="http://gallery.technet.microsoft.com/Using-DSC-to-keep-SMA-a0fce35f" target="_blank">TechNet here</a> and import it using SMART.</p>

<p>Note:<br />
The unattend command line syntax is valid for R2 versions of OpsMgr and VMM Console and may differ if you are using another version.</p>

<p>I usually keep DSC configurations separated from the logic, but to keep it a little bit simpler for this example I included the configuration within the SMA runbook.</p>

<p>Â </p>

<p><strong>Â Disclaimer</strong></p>

<p>THE SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED â€œAS ISâ€ WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED,<br />
INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE</p>

<p>Â </p>
:ET