I"·<p>In SQL Server 2005 and later Triggers can be more than simple T-SQL statements. You can include complete procedures and program code.<br />
This post describes how toÂ  create a â€œCommon Language Runtimeâ€ Trigger on a SQL Database which fires on INSERTS into a specific table.<br />
A CLR Trigger is a kind of stored procedure including .net compiled program code.</p>

<p><strong>Step 1 (Create the .NET CLR Code)</strong></p>

<p>Create a piece of code in Visual Studio or in an editor of your choice.<br />
The sample code watches a table for inserts and starts a pwershell script with the inserted values as arguments. Of course you can do much more complex things than run a script.<br />
You can use vb.net, c# or either c++ as source language</p>

<p>SaveÂ  the file under C:\cla_trigger.vb</p>

<pre>Imports System.Data.SqlClient</pre>

<pre>Imports Microsoft.SqlServer.Server</pre>

<pre>Imports System</pre>

<pre>Imports System.IO</pre>

<pre>Imports System.Diagnostics</pre>

<pre>Public Class sqltrigger</pre>

<pre>Â Â Â  &lt;SqlTrigger(Name:="SessionTrigger", Target:="&lt;your table name&gt;", Event:="FOR UPDATE")&gt; _</pre>

<pre>Â Â Â  Public Shared Sub UserNameAudit()</pre>

<pre>Â Â Â Â Â Â Â  'Define SQL query result variables</pre>

<pre>Â Â Â Â Â Â Â  Dim susername As String</pre>

<pre>Â Â Â Â Â Â Â  Dim sComputername As String</pre>

<pre>Â Â Â Â Â Â Â  Dim sID As Integer</pre>

<pre>Â Â Â Â Â Â Â  'Define contect of CLR Trigger</pre>

<pre>Â Â Â Â Â Â Â  Dim triggContext As SqlTriggerContext = SqlContext.TriggerContext()</pre>

<pre>Â Â Â Â Â Â Â  Try</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â  If triggContext.TriggerAction = TriggerAction.Insert Then</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Using conn As New SqlConnection("context connection=true")</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  conn.Open()</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Dim sqlComm As New SqlCommand</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Dim sqlP As SqlPipe = SqlContext.Pipe()</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sqlComm.Connection = conn</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sqlComm.CommandText = "SELECT USERNAME from INSERTED"</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  susername = sqlComm.ExecuteScalar.ToString()</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sqlComm.CommandText = "SELECT COMPUTERNAME from INSERTED"</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sComputername = sqlComm.ExecuteScalar.ToString()</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sqlComm.CommandText = "SELECT ID from INSERTED"</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sID = sqlComm.ExecuteScalar.ToString()</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ' New ProcessStartInfo created</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Dim proc As New ProcessStartInfo</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  proc.FileName = "C:\Windows\system32\WindowsPowershell\V1.0\powershell.exe</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  proc.Arguments = "C:\Scripts\triggeroutput.ps1" _
Â                    &amp; " " &amp; sID &amp; " " &amp; susername &amp; " " &amp; sComputername</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  proc.WindowStyle = ProcessWindowStyle.Hidden</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ' Start the process</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Process.Start(proc)</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  End Using</pre>

<pre>Â Â Â Â Â Â Â Â Â Â Â  End If</pre>

<pre>Â Â Â Â Â Â Â  Catch ex As Exception</pre>

<pre>Â Â Â Â Â Â Â  End Try</pre>

<pre>Â Â Â  End Sub</pre>

<p><strong>Step 2 (compile the code to a dll (class)</strong><br />
C:\Windows\Microsoft.NET\Framework\v2.0.50727/vbc.exe /t:library /out:C:\CLRTrigger.dll /r:sqlaccess.dll C:\cla_trigger.vb</p>

<p><strong>Step 3 (prepare the database for CLR Trigger Operations)</strong></p>

<pre>ALTER DATABASE &lt;your database&gt; SET TRUSTWORTHY ON
go
sp_configure 'clr enabled', 1
Go
RECONFIGURE with Override
Go

DROP TRIGGER InsertTrigger
DROP ASSEMBLY clrtrigger
CREATE ASSEMBLY clrtrigger
FROM 'C:\CLRTrigger.dll'
go 

CREATE TRIGGER InsertTrigger
ON &lt;your table&gt;
FOR INSERT
AS
EXTERNAL NAME clrtrigger.sqltrigger.UserNameAudit
go</pre>
:ET