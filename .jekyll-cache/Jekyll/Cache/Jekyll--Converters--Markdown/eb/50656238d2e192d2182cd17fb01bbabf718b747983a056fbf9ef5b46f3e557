I"X<p>The following code enables a file based locking mechanism within a powershell script. It checks for existance of a lock file and checks if a running process exists, which is capturing this file. This can be used in situations, where a script is beeing launched paralell by another script or programm, but you want to have your script executed exclusively and serialized.</p>

<p><span style="font-family:Times New Roman; font-size:12pt">The following code enables a file based locking mechanism within a powershell script. It checks for existance of a lock file and checks if a running process exists, which is capturing this file. This can be used in situations, where a script is beeing launched parallel by another script or programm, but you want to have your script executed exclusively and serialized.<br /> </span></p>

<p><span style="font-family:Times New Roman; font-size:12pt"><br /></span><span style="color:#92d050; font-family:Courier New; font-size:10pt">#################################################<br />#Scriptname:Â Â Â  Â checklock.ps1<br />#Author: Â Â Â  Â Â Â  Michael RÃ¼efli (www.miru.ch)<br />#Date:Â Â Â  Â Â Â  Â Â Â 21.11.2009<br />#Description:Â Â Â  The code uses a file locking mechanism to ensure that the<br />#Â Â Â  Â Â Â  Â Â Â  Â Â Â  script beeing started is running exclusively. Mostly used where<br />#Â Â Â  Â Â Â  Â Â Â  Â Â Â  a powershell script is started parallel within a few seconds<br />#<br />#Usage:Â Â Â  Â Â Â  Â Â Paste your code in the MAIN section and set the $lockfile paramater to match your needs<br />############################################<br /> </span></p>

<p><span style="color:#c4bc96; font-family:Courier New; font-size:10pt">$lockfile = â€œd:\lock.lckâ€<br />$lockstatus = 0<br />While ($lockstatus -ne 1)<br />{<br />If (Test-Path $lockfile)<br />{<br />echo â€œLock file found!â€<br />$pidlist = Get-content $lockfile<br />If (!$pidlist)<br />{<br />$PID | Out-File $lockfile<br />$lockstatus = 1<br />}<br />$currentproclist = Get-Process | ? { $_.id -match $pidlist }<br />If ($currentproclist)<br />{<br />echo â€œlockfile in use by other process!â€<br />$rndwait = New-Object system.Random<br />$rndwait= $rndwait.next(1,4)<br />echo â€œSleeping for $rndwait secondsâ€<br />Start-Sleep $rndwait<br />}<br />Else<br />{<br /> </span></p>

<p><span style="color:#c4bc96; font-family:Courier New; font-size:10pt">Remove-Item $lockfile -Force<br />$PID | Out-File $lockfile<br />$lockstatus = 1<br /> </span></p>

<p><span style="color:#c4bc96; font-family:Courier New; font-size:10pt">}<br />}<br />Else<br />{<br />$PID | Out-File $lockfile<br />$lockstatus = 1<br />}<br />}<br /> </span></p>

<p><span style="color:#c4bc96; font-family:Courier New; font-size:10pt">#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“<br />## Main Script Part<br />## Here you can paste your code, in fact what the script has to do<br />echo â€œHi, it seems that no other script is doing the same as me now.. so I can do my job exclusivelyâ€<br /> </span></p>

<p><span style="color:#c4bc96; font-family:Courier New; font-size:10pt">## End of Main Part<br />#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“<br />#remove the lockfile<br />Remove-Item $lockfile â€“Force<br /> </span></p>

<p>Â </p>

<p><a href="http://images.google.ch/imgres?imgurl=http://www.gnr8.biz/images/blue_lock%2520main.jpg&amp;imgrefurl=http://www.gnr8.biz/product_info.php%3Fproducts_id%3D304&amp;usg=__zSEp805411nm-VqQyBYugBeRgwE=&amp;h=432&amp;w=432&amp;sz=49&amp;hl=de&amp;start=2&amp;tbnid=FZ87K5zi-ppJzM:&amp;tbnh=126&amp;tbnw=126&amp;prev=/images%3Fq%3Dlock%26gbv%3D2%26hl%3Dde"><img src="http://www.miru.ch/wp-content/uploads/2010/01/112109-1453-howtoimplem1.jpg" alt="" border="0" /></a><span style="color:#c4bc96; font-family:Courier New; font-size:10pt"><br /> </span></p>
:ET