I"<p>In one of my recent <a href="http://www.miru.ch/automating-online-extension-of-a-csv-using-powershell/" target="_blank">posts</a>, I showed how to extendÂ  a CSV using Powershell and DISKPART. As Iâ€™m constantly trying to avoid using â€œlegacyâ€ command line tools, I decided to find a way around DISKPART.Therefore I was able to create a Powershell Function to extend a CSV on a Windows Failover Cluster.</p>

<p>As you might already know, the operation has to be performed on the Coordinator node, the CSV owner. The function helps you here too.</p>

<ul>
  <li>Searches for the current owner node of the CSV</li>
  <li>Checks if a WinRM session can be established to the owner node and creates a persisent Remote Powershell Session</li>
  <li>Getâ€™s the physical disk and partition ID from the CSV</li>
  <li>Extends the CSV to itâ€™s maximum available extend</li>
</ul>

<p>Prerequisites:</p>

<ul>
  <li>Server 2008 R2 or higher</li>
  <li>Powershell 3.0</li>
  <li>Failover Clustering Powershell Module (RSAT-Clustering-Powershell)</li>
  <li>The physical LUN has already be extended on your Storage Space, SAN, NAS</li>
</ul>

<p>And here it isâ€¦</p>

<pre>Function Extend-csv
{
Â Â Â  [CmdletBinding(SupportsShouldProcess=$true)]
Â Â Â  param
Â Â Â  (
Â Â Â  [Parameter(Mandatory=$True)]
Â Â Â  [STRING]$csvname,
Â Â Â  [Parameter(Mandatory=$True)]
Â Â Â  [STRING]$clusternameÂ Â  Â 
Â Â Â  )

Â Â Â  #Check for Failover Cluster Powershell Module Presence
Â Â Â  If (!(Get-Module FailoverClusters)) {write-warning "Install Failover Clustering Powershell Module first!";break}

Â Â Â  #Get the owner of the CSV and some ID info
Â Â Â  $csv = Try {Get-ClusterSharedVolume -Cluster $clusternameÂ  -ErrorAction STOP | ? {$_.Name -eq "$csvname"} } Catch {}
Â Â Â  If (!$csv) {write-warning "No CSV with Name $csvname found on Cluster $clustername";break}
Â Â Â  $csv_owner = $csv.OwnerNode.name
Â Â Â  $csv_id = $csv.id

Â Â Â  #Establish a new WinRM Session with the CSV owner node
Â Â Â  $session = Try {New-PSSession -ComputerName $csv_owner -ErrorAction STOP} Catch {Write-Warning "Error while trying to establish a WinRM Session to Host: $csv_owner";break}

Â Â Â  #Execute the commands on the remote host (CSV Owner)
Â Â Â  Invoke-Command -Session $session -Scriptblock {
Â Â Â Â Â Â Â  #Rescan the storage
Â Â Â Â Â Â Â  Update-HostStorageCache;

Â Â Â Â Â Â Â  #Get the Disk ID of the CSV corresponding LUN
Â Â Â Â Â Â Â  $csv_disk_id = (Get-ItemProperty "HKLM:\Cluster\Resources\$USING:csv_id\Parameters").DiskIdGuid;

Â Â Â Â Â Â Â  #Query the physical Disk
Â Â Â Â Â Â Â  $physicaldisk = Get-Disk | ? {$_.Guid -eq $csv_disk_id};

Â Â Â Â Â Â Â  #Get the partition
Â Â Â Â Â Â Â  $partition = Get-Partition -Disk $physicaldisk | ? {$_.Type -ne 'Reserved'}

Â Â Â Â Â Â Â  #Resize the Partition
Â Â Â Â Â Â Â  $newsize = $partition.Size + $physicaldisk.LargestFreeExtent
Â Â Â Â Â Â Â  $newsizeGB = ($newsize / 1024 / 1024 / 1024)
Â Â Â Â Â Â Â  Try
Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â  Resize-Partition -DiskNumber $partition.DiskNumber -PartitionNumber $partition.PartitionNumber -Size $newsize -ErrorAction STOP -ErrorVariable EXTENDERR;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  Catch
Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â  Write-Warning "Invalid Size or no free space to extend the volume";
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  If (!$EXTENDERR) {Write-Output "Cluster Shared Volume: $csvname on Cluster: $clustername has been successfully extended to $newsizeGB GB"}

Â Â Â  }

Â Â Â  #Cleaning Up the Powershell Remote Session
Â Â Â  Remove-PSSession $session.ID;
}</pre>
:ET